<!DOCTYPE html>
<html>
<head>
    <title>ğŸš¨ ç·Šæ€¥ä¿®å¾©å·¥å…·</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 50px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto;
            background: rgba(255,255,255,0.1); 
            padding: 40px; 
            border-radius: 15px; 
            backdrop-filter: blur(10px);
            text-align: center;
        }
        h1 { font-size: 2.5em; margin-bottom: 30px; }
        .problem { 
            background: rgba(255,0,0,0.2); 
            padding: 20px; 
            border-radius: 10px; 
            margin: 20px 0; 
            border: 1px solid rgba(255,0,0,0.5);
        }
        .solution { 
            background: rgba(0,255,0,0.2); 
            padding: 20px; 
            border-radius: 10px; 
            margin: 20px 0; 
            border: 1px solid rgba(0,255,0,0.5);
        }
        button { 
            font-size: 1.5em;
            padding: 20px 40px; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        button:hover { background: #45a049; transform: scale(1.05); }
        .danger { background: #f44336; }
        .danger:hover { background: #da190b; }
        .result { 
            margin: 30px 0; 
            padding: 20px; 
            border-radius: 10px; 
            text-align: left;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: rgba(0,255,0,0.2); border: 1px solid rgba(0,255,0,0.5); }
        .error { background: rgba(255,0,0,0.2); border: 1px solid rgba(255,0,0,0.5); }
        .loading { background: rgba(255,255,0,0.2); border: 1px solid rgba(255,255,0,0.5); }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš¨ ç·Šæ€¥ä¿®å¾©å·¥å…·</h1>
        
        <div class="problem">
            <h2>ğŸ” æª¢æ¸¬åˆ°çš„å•é¡Œ</h2>
            <p><strong>SQLITE_ERROR: no such table: users</strong></p>
            <p>è³‡æ–™åº«ä¸­ç¼ºå°‘ users è¡¨ï¼Œå°è‡´ç™»éŒ„å¤±æ•—</p>
        </div>

        <div class="solution">
            <h2>ğŸ”§ è§£æ±ºæ–¹æ¡ˆ</h2>
            <p>é»æ“Šä¸‹é¢çš„æŒ‰éˆ•é‡å»ºè³‡æ–™åº«ï¼Œé€™æœƒï¼š</p>
            <ul style="text-align: left;">
                <li>âœ… å‰µå»º users è¡¨</li>
                <li>âœ… æ’å…¥ç®¡ç†å“¡å¸³è™Ÿï¼šadmin / password</li>
                <li>âœ… æ’å…¥æ¸¬è©¦ç”¨æˆ¶</li>
                <li>âœ… ç¢ºä¿ç³»çµ±æ­£å¸¸é‹è¡Œ</li>
            </ul>
        </div>

        <button onclick="emergencyFix()" class="danger">ğŸš¨ ä¸€éµä¿®å¾©è³‡æ–™åº«</button>
        <br>
        <button onclick="testLogin()">ğŸ” æ¸¬è©¦ç™»éŒ„</button>
        <button onclick="checkHealth()">ğŸ¥ æª¢æŸ¥ç³»çµ±ç‹€æ…‹</button>

        <div id="result" style="display: none;"></div>
    </div>

    <script>
        function log(message, type = 'loading') {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result ' + type;
            resultDiv.innerHTML = message;
        }

        async function emergencyFix() {
            log('ğŸ”§ æ­£åœ¨åŸ·è¡Œç·Šæ€¥ä¿®å¾©...\nè«‹ç¨å€™ï¼Œé€™å¯èƒ½éœ€è¦å¹¾ç§’é˜...', 'loading');
            
            try {
                const response = await fetch('/force-rebuild-db', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                let message = 'ğŸ”§ ä¿®å¾©çµæœ:\n\n';
                message += `ç‹€æ…‹: ${response.status}\n`;
                message += `éŸ¿æ‡‰: ${JSON.stringify(data, null, 2)}\n\n`;
                
                if (response.ok && data.success) {
                    message += 'âœ… ç·Šæ€¥ä¿®å¾©æˆåŠŸï¼\n';
                    message += `ğŸ“Š å‰µå»ºäº† ${data.userCount} å€‹ç”¨æˆ¶\n`;
                    message += 'ğŸ”‘ ç®¡ç†å“¡å¸³è™Ÿ: admin / password\n\n';
                    message += 'ğŸ¯ ç¾åœ¨ä½ å¯ä»¥:\n';
                    message += 'â€¢ é»æ“Šã€Œæ¸¬è©¦ç™»éŒ„ã€é©—è­‰ä¿®å¾©\n';
                    message += 'â€¢ å›åˆ°åŸå§‹ç™»éŒ„é é¢ä½¿ç”¨ admin/password ç™»éŒ„\n';
                    message += 'â€¢ è¨ªå•ç®¡ç†å¾Œå°é€²è¡Œç®¡ç†\n';
                    
                    log(message, 'success');
                } else {
                    message += 'âŒ ä¿®å¾©å¤±æ•—\n';
                    message += 'è«‹æª¢æŸ¥æœå‹™å™¨æ—¥å¿—æˆ–è¯ç¹«æŠ€è¡“æ”¯æ´\n';
                    log(message, 'error');
                }
                
            } catch (error) {
                log(`âŒ ä¿®å¾©éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:\n${error.message}`, 'error');
            }
        }

        async function testLogin() {
            log('ğŸ” æ­£åœ¨æ¸¬è©¦ç™»éŒ„...', 'loading');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'password' })
                });
                
                const data = await response.json();
                
                let message = 'ğŸ” ç™»éŒ„æ¸¬è©¦çµæœ:\n\n';
                message += `ç‹€æ…‹: ${response.status}\n`;
                message += `éŸ¿æ‡‰: ${JSON.stringify(data, null, 2)}\n\n`;
                
                if (response.ok && data.success) {
                    message += 'âœ… ç™»éŒ„æ¸¬è©¦æˆåŠŸï¼\n';
                    message += `ğŸ‘¤ ç”¨æˆ¶: ${data.user.username}\n`;
                    message += `ğŸ›¡ï¸ è§’è‰²: ${data.user.role}\n\n`;
                    message += 'ğŸ‰ ç³»çµ±å·²å®Œå…¨ä¿®å¾©ï¼\n';
                    message += 'ç¾åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨ admin/password ç™»éŒ„äº†\n';
                    
                    // å„²å­˜ä»¤ç‰Œ
                    localStorage.setItem('token', data.token);
                    
                    log(message, 'success');
                } else {
                    message += 'âŒ ç™»éŒ„æ¸¬è©¦å¤±æ•—\n';
                    message += 'å¯èƒ½éœ€è¦å†æ¬¡åŸ·è¡Œã€Œä¸€éµä¿®å¾©ã€\n';
                    log(message, 'error');
                }
                
            } catch (error) {
                log(`âŒ ç™»éŒ„æ¸¬è©¦éŒ¯èª¤:\n${error.message}`, 'error');
            }
        }

        async function checkHealth() {
            log('ğŸ¥ æ­£åœ¨æª¢æŸ¥ç³»çµ±å¥åº·ç‹€æ…‹...', 'loading');
            
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                let message = 'ğŸ¥ ç³»çµ±å¥åº·æª¢æŸ¥:\n\n';
                message += JSON.stringify(data, null, 2) + '\n\n';
                
                if (data.database && data.database.status === 'ok') {
                    message += 'âœ… è³‡æ–™åº«ç‹€æ…‹æ­£å¸¸\n';
                    message += `ğŸ“Š ç”¨æˆ¶æ•¸é‡: ${data.database.userCount}\n`;
                    log(message, 'success');
                } else {
                    message += 'âŒ è³‡æ–™åº«ç‹€æ…‹ç•°å¸¸\n';
                    message += 'è«‹åŸ·è¡Œã€Œä¸€éµä¿®å¾©è³‡æ–™åº«ã€\n';
                    log(message, 'error');
                }
                
            } catch (error) {
                log(`âŒ å¥åº·æª¢æŸ¥éŒ¯èª¤:\n${error.message}`, 'error');
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥å¥åº·ç‹€æ…‹
        window.addEventListener('load', checkHealth);
    </script>
</body>
</html>